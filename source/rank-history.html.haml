%h2
  ATP rank history
  %span.generated-note (generated at <span class='generated-at'></span>)

#rank-history
  %svg

#timespan
  Time span:
  %select(name='fromYear')
  \-
  %select(name='toYear')
  %button.update Update Graph

#players

%link(href='stylesheets/nv.d3.css' rel='stylesheet')
%script(src='javascripts/vendor/d3.v2.min.js')
%script(src='javascripts/vendor/nv.d3.min.js')
%script(src='data/rankings.js')
:javascript
  window.onload = function(){
    updateGenerationTime(rankings.generated_at);
    $('[name=fromYear]').change(changeFromYear);

    $.each(rankings.data, function(i, r){
      if (i >= 10) return;

      var name = r.first + ' ' + r.last;
      var value = (r.first + '_' + r.last).toLowerCase().replace(/[ -]/g, '_');
      $('#players').append('<div class="player"><input type="checkbox" name="player" value="' + value + '"><span>' + name + '</span></div>');
    });

    $('button.update').click(function(){
      var players = $('[name=player]:checked').map(function(){
        return this.value;
      });
      if (players.length === 0) {
        alert('No player is selected.');
      } else if (players.length === 1) {
        window.location = location.pathname + '?players=' + players[0];
      } else {
        var s = players[0];
        for (var i=1; i<players.length; i++) {
          s += ',' + players[i];
        }
        window.location = location.pathname + '?players=' + s + '&fromYear=' + $('[name=fromYear]').val() + '&toYear=' + $('[name=toYear]').val();
      }
    });

    var fromYear = 2003;
    var fromYearParam = getQueryVar('fromYear');
    if (fromYearParam) {
      fromYear = parseInt(fromYearParam);
    }
    initFromYear();
    $('[name=fromYear]').val(fromYear);

    var toYear = getYear();
    var toYearParam = getQueryVar('toYear');
    if (toYearParam) {
      toYear = parseInt(toYearParam);
    }
    initToYear(fromYear);
    $('[name=toYear]').val(toYear);

    var players = null;
    var playersParam = getQueryVar('players');
    if (playersParam && playersParam !== '') {
      players = playersParam.split(',');
    } else {
      players = ['novak_djokovic', 'roger_federer', 'rafael_nadal', 'andy_murray'];
    }
    $.each(players, function(i, p){ $('[value=' + p + ']').click(); });

    loadAndShowRankHistory(players, fromYear, toYear);
  }

