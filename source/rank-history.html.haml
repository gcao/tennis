.h2
  ATP rank history
  %span.generated-note (generated at <span class='generated-at'></span>)
  %button.update Update Graph

#players

#rank-history
  %svg

= stylesheet_link_tag 'nv.d3'
= javascript_include_tag 'vendor/d3.v2.min'
= javascript_include_tag 'vendor/nv.d3.min'
= javascript_include_tag '/data/rankings'
= javascript_include_tag '/data/roger_federer_rank_history'
= javascript_include_tag '/data/rafael_nadal_rank_history'
= javascript_include_tag '/data/novak_djokovic_rank_history'
= javascript_include_tag '/data/andy_murray_rank_history'
:javascript
  window.onload = function(){
    $('.generated-at').text(rankings.generated_at);

    $.each(rankings.data, function(i, r){
      var name = r.first + ' ' + r.last;
      var value = (r.first + '_' + r.last).toLowerCase();
      $('#players').append('<div class="player"><input type="checkbox" name="player" value="' + value + '"><span>' + name + '</span></div>');
    });

    $('button.update').click(function(){
      var data = $.map($('[name=player]:checked').map(function(){
        return eval('window.' + this.value + '_rank_history');
      }), function(e) {
        return {key: e.first + ' ' + e.last, values: e.history}; 
      });

      console.log(data);

      nv.addGraph(function() {
        var chart = nv.models.lineChart()
                      .x(function(d) { return Date.parse(d[0]) })
                      .y(function(d) { return 50 - d[1] })
                      .color(d3.scale.category10().range());

        chart.xAxis
             .rotateLabels(30)
             .tickValues(function(){
               return $.map([2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013], function(year) {
                 return Date.parse('1/1/' + year);
               });
             }())
             .tickFormat(function(d) {
               return d3.time.format('%x')(new Date(d));
             });

        chart.yAxis
             .tickValues([0, 10, 20, 30, 40, 45, 46, 47, 48, 49])
             .showMaxMin(false)
             .tickFormat(function(d) {
               return 50-d;
             });

        d3.select('#rank-history svg')
          .datum(data)
          .transition().duration(500)
          .call(chart);

        nv.utils.windowResize(chart.update);

        window.chart = chart;
        return chart;
      });
    });

    $('[value=novak_djokovic]').click();
    $('[value=roger_federer]').click();
    $('[value=rafael_nadal]').click();
    $('[value=andy_murray]').click();
    $('button.update').click();
  }

